name: Sincronizar a GitLab

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Empujar a GitLab (rama + tags)
        env:
          USERNAME: "aichumailla"
          TOKEN: ${{ secrets.GEOGAS }}
          GITLAB_PATH: "eliasbuenosdias1-group/GeoGas.git"
        run: |
          # URL completa del remoto GitLab
          REMOTE_URL="https://${USERNAME}:${TOKEN}@gitlab.com/${GITLAB_PATH}"
          
          echo "Configurando remoto GitLab..."
          git remote add gitlab "$REMOTE_URL" || git remote set-url gitlab "$REMOTE_URL"
          
          echo "Empujando cambios a la rama master..."
          git push gitlab master --force
          
          echo "Empujando tags..."
          git push gitlab --tags --force

      - name: Crear/actualizar release en GitLab con enlace a la APK de GitHub
        env:
          GITLAB_TOKEN: ${{ secrets.GEOGAS }}
          GITLAB_PROJECT_ID: "77120516"  # ID numérico de tu proyecto en GitLab
          TAG_NAME: "v1.0.0"
          GITHUB_APK_URL: "https://github.com/eliasbuenosdias/GeoGas/releases/download/v1.0.0/GeoGas-1.0.0.apk"
        run: |
          API="https://gitlab.com/api/v4/projects/${77120516}"

          echo "Creando/actualizando release ${TAG_NAME} en GitLab..."

          # Crear release (si no existe)
          curl --silent --show-error --fail \
               --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
               --header "Content-Type: application/json" \
               --data "{\"name\": \"GeoGas ${TAG_NAME}\", \"tag_name\": \"${TAGNAME}\"}" \
               --request POST "${API}/releases" || \
          # Si ya existe, actualizar solo el nombre
          curl --silent --show-error --fail \
               --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
               --header "Content-Type: application/json" \
               --data "{\"name\": \"GeoGas ${TAG_NAME}\"}" \
               --request PUT "${API}/releases/${TAG_NAME}"

          echo "Añadiendo enlace al APK de GitHub como asset..."

          curl --silent --show-error --fail \
               --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
               --header "Content-Type: application/json" \
               --data "{\"name\": \"GeoGas APK (GitHub)\", \"url\": \"${GITHUB_APK_URL}\"}" \
               --request POST "${API}/releases/${TAG_NAME}/assets/links" || echo "El asset ya existe o no se pudo crear"
